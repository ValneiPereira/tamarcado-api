# Deploy to EC2 via SSH + Docker Compose
# Optimized for EC2 t4g.micro (ARM64, 1GB RAM, ~$6/month)
#
# Required GitHub Secrets:
#   EC2_HOST          - Public IP or Elastic IP of EC2 instance
#   EC2_USERNAME      - Usually 'ec2-user' for Amazon Linux
#   EC2_SSH_KEY       - Private key content (the .pem file content)

name: Deploy to EC2

on:
  push:
    branches: [main, master]
  workflow_dispatch: # Manual trigger

jobs:
  test:
    name: Run Tests
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: maven

      - name: Run tests
        run: mvn verify -B

  deploy:
    name: Deploy to EC2
    needs: test
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.EC2_SSH_KEY }}" > ~/.ssh/ec2-key.pem
          chmod 600 ~/.ssh/ec2-key.pem
          ssh-keyscan -H ${{ secrets.EC2_HOST }} >> ~/.ssh/known_hosts 2>/dev/null || true

      - name: Deploy to EC2
        run: |
          ssh -i ~/.ssh/ec2-key.pem -o StrictHostKeyChecking=no ${{ secrets.EC2_USERNAME }}@${{ secrets.EC2_HOST }} << 'ENDSSH'
            set -e

            echo "=== Updating repository ==="
            cd ~/tamarcado-api || git clone https://github.com/${{ github.repository }}.git ~/tamarcado-api
            cd ~/tamarcado-api
            git fetch origin
            git reset --hard origin/${{ github.ref_name }}

            echo "=== Building and deploying with Docker Compose ==="
            docker-compose -f docker-compose.prod.yml --env-file .env.prod up -d --build --remove-orphans

            echo "=== Waiting for API to start (Java needs time on 1GB RAM) ==="
            sleep 90

            echo "=== Checking health ==="
            RETRIES=5
            for i in $(seq 1 $RETRIES); do
              if curl -sf http://localhost:8080/api/v1/actuator/health; then
                echo ""
                echo "=== Health check passed! ==="
                break
              fi
              if [ $i -eq $RETRIES ]; then
                echo "=== Health check failed after $RETRIES attempts ==="
                echo "=== Container logs: ==="
                docker logs --tail 50 tamarcado-api
                exit 1
              fi
              echo "Attempt $i/$RETRIES failed, retrying in 15s..."
              sleep 15
            done

            echo "=== Cleaning old images ==="
            docker image prune -f

            echo "=== Deploy completed! ==="
            echo "=== Memory usage: ==="
            free -m
            docker stats --no-stream
          ENDSSH

      - name: Deployment Summary
        run: |
          echo "## Deployment to EC2 Successful!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Host:** \`${{ secrets.EC2_HOST }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Branch:** \`${{ github.ref_name }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Architecture:** ARM64 (Graviton t4g.micro)" >> $GITHUB_STEP_SUMMARY
